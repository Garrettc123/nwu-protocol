name: ðŸ“„ Automated Release

on:
  push:
    branches: [main]
    paths:
      - 'backend/package.json'
      - 'frontend/package.json'
      - 'contracts/package.json'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
      component:
        description: 'Component to release'
        required: true
        type: choice
        options:
          - all
          - backend
          - frontend
          - contracts

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION=${{ github.event.inputs.version }}
          else
            VERSION=$(date +%Y.%m.%d)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "changelog=$(git log $(git describe --tags --abbrev=0)..HEAD --pretty=format:'%h %s' | head -20)" >> $GITHUB_OUTPUT

  backend-release:
    name: Release Backend
    needs: prepare-release
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.component == 'all' || 
      github.event.inputs.component == 'backend' ||
      hashFiles('backend/**') != ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          cache: ${{ hashFiles('backend/package-lock.json') != '' && 'npm' || '' }}
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        run: cd backend && npm ci
      
      - name: Run tests
        run: cd backend && npm test
      
      - name: Build
        run: cd backend && npm run build
      
      - name: Update version
        run: cd backend && npm version ${{ needs.prepare-release.outputs.version }} --no-git-tag-version
      
      - name: Publish to npm
        run: cd backend && npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/nwu-backend:${{ needs.prepare-release.outputs.version }} \
                       -t ${{ env.REGISTRY }}/nwu-backend:latest \
                       ./backend
      
      - name: Push Docker image
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          docker push ${{ env.REGISTRY }}/nwu-backend:${{ needs.prepare-release.outputs.version }}
          docker push ${{ env.REGISTRY }}/nwu-backend:latest
        continue-on-error: true

  frontend-release:
    name: Release Frontend
    needs: prepare-release
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.component == 'all' || 
      github.event.inputs.component == 'frontend' ||
      hashFiles('frontend/**') != ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: ${{ hashFiles('frontend/package-lock.json') != '' && 'npm' || '' }}
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: cd frontend && npm ci
      
      - name: Run tests
        run: cd frontend && npm test -- --coverage
      
      - name: Build
        run: cd frontend && npm run build
      
      - name: Deploy to Vercel
        uses: vercel/action@master
        with:
          working-directory: frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        continue-on-error: true
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/nwu-frontend:${{ needs.prepare-release.outputs.version }} \
                       -t ${{ env.REGISTRY }}/nwu-frontend:latest \
                       ./frontend
      
      - name: Push Docker image
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          docker push ${{ env.REGISTRY }}/nwu-frontend:${{ needs.prepare-release.outputs.version }}
          docker push ${{ env.REGISTRY }}/nwu-frontend:latest
        continue-on-error: true

  contracts-release:
    name: Release Smart Contracts
    needs: prepare-release
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.component == 'all' || 
      github.event.inputs.component == 'contracts' ||
      hashFiles('contracts/**') != ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
          cache: ${{ hashFiles('contracts/package-lock.json') != '' && 'npm' || '' }}
          cache-dependency-path: contracts/package-lock.json
      
      - name: Install dependencies
        run: cd contracts && npm ci
      
      - name: Compile contracts
        run: cd contracts && npm run compile
      
      - name: Run tests
        run: cd contracts && npm test
      
      - name: Update version
        run: cd contracts && npm version ${{ needs.prepare-release.outputs.version }} --no-git-tag-version
      
      - name: Publish to npm
        run: cd contracts && npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

  create-release:
    name: Create GitHub Release
    needs: [prepare-release, backend-release, frontend-release, contracts-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.prepare-release.outputs.version }}
          release_name: Release ${{ needs.prepare-release.outputs.version }}
          body: |
            # Release ${{ needs.prepare-release.outputs.version }}
            
            ## Changes
            ${{ needs.prepare-release.outputs.changelog }}
            
            ## Components Released
            - âœ… Backend
            - âœ… Frontend  
            - âœ… Smart Contracts
            
            ## Docker Images
            - `ghcr.io/${{ github.repository }}/nwu-backend:${{ needs.prepare-release.outputs.version }}`
            - `ghcr.io/${{ github.repository }}/nwu-frontend:${{ needs.prepare-release.outputs.version }}`
          draft: false
          prerelease: false
        continue-on-error: true

  notify-release:
    name: Notify Release
    needs: [prepare-release, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Post to Discord
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "Release Published"
          description: "Version ${{ needs.prepare-release.outputs.version }} is now available!"
          color: 0x28a745
        continue-on-error: true
      
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "NWU Protocol v${{ needs.prepare-release.outputs.version }} released! ðŸ“„",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*NWU Protocol Release* \nVersion: `${{ needs.prepare-release.outputs.version }}`\n<${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.prepare-release.outputs.version }}|View Release>"
                  }
                }
              ]
            }
        continue-on-error: true
