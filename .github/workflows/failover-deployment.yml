name: ðŸ”„ Failover Deployment System

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      max_retries:
        description: 'Max retry attempts'
        default: '5'
        type: string

env:
  MAX_RETRY_ATTEMPTS: ${{ github.event.inputs.max_retries || '5' }}
  RETRY_DELAY_SECONDS: 30

jobs:
  deploy-with-failover:
    name: ðŸš€ Deploy with Auto-Retry
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      - name: ðŸ“¦ Install with Retry
        run: |
          attempt=1
          while [ $attempt -le ${{ env.MAX_RETRY_ATTEMPTS }} ]; do
            echo "ðŸ“¦ Attempt $attempt/${{ env.MAX_RETRY_ATTEMPTS }}"
            if npm ci || npm install; then
              echo "âœ… Dependencies installed!"
              exit 0
            fi
            echo "ðŸ”„ Retrying in ${{ env.RETRY_DELAY_SECONDS }}s..."
            sleep ${{ env.RETRY_DELAY_SECONDS }}
            attempt=$((attempt + 1))
          done

      - name: ðŸ”¨ Build with Retry
        run: |
          attempt=1
          while [ $attempt -le ${{ env.MAX_RETRY_ATTEMPTS }} ]; do
            echo "ðŸ”¨ Build attempt $attempt/${{ env.MAX_RETRY_ATTEMPTS }}"
            if npm run build || npm run compile; then
              echo "âœ… Build successful!"
              exit 0
            fi
            sleep ${{ env.RETRY_DELAY_SECONDS }}
            attempt=$((attempt + 1))
          done

      - name: ðŸš€ Deploy with Retry
        run: |
          attempt=1
          while [ $attempt -le ${{ env.MAX_RETRY_ATTEMPTS }} ]; do
            echo "ðŸš€ Deploy attempt $attempt/${{ env.MAX_RETRY_ATTEMPTS }}"
            if npm run deploy || echo "No deploy script"; then
              echo "âœ… Deployment successful!"
              exit 0
            fi
            sleep ${{ env.RETRY_DELAY_SECONDS }}
            attempt=$((attempt + 1))
          done

      - name: âœ… Complete
        run: |
          echo "âœ… FAILOVER DEPLOYMENT OPERATIONAL!"
