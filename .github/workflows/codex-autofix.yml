name: Codex Auto-Fix on Failure

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  push:
    branches: [main, master, develop]
  pull_request:

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read

jobs:
  auto-fix:
    if: github.event.workflow_run.conclusion == 'failure' || github.event_name == 'push'
    runs-on: ubuntu-latest
    
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    
    steps:
      - name: Checkout Failing Ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0

      - name: Fetch PR and Branch References
        env:
          HEAD_BRANCH_REF: ${{ github.event.workflow_run.head_branch || github.ref_name }}
        run: |
          git fetch origin '+refs/pull/*/head:refs/remotes/origin/pr/*' || true
          git fetch origin "$HEAD_BRANCH_REF" || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      - name: Install Dependencies
        run: npm ci || npm install

      - name: Run Codex Fix
        id: codex
        run: |
          # Install OpenAI CLI
          pip install openai requests PyYAML
          
          # Create fix script
          cat > autofix.py << 'EOFPYTHON'
          import os, json, openai, subprocess
          from datetime import datetime
          
          openai.api_key = os.environ["OPENAI_API_KEY"]
          
          # Get failure logs
          try:
              logs = subprocess.run(["npm", "test"], capture_output=True, text=True).stderr
          except:
              logs = "No test logs available"
          
          # Get repository context
          files = subprocess.run(["git", "ls-files"], capture_output=True, text=True).stdout
          
          # Generate fix with Codex
          response = openai.ChatCompletion.create(
              model="gpt-4",
              messages=[
                  {"role": "system", "content": "You are an expert CI/CD debugger. Analyze failures and provide precise fixes."},
                  {"role": "user", "content": f"""CI Pipeline Failed:
          
          LOGS:
          {logs[:3000]}
          
          FILES:
          {files[:1000]}
          
          Provide:
          1. Root cause analysis
          2. Exact file changes needed with full file paths
          3. Fixed code
          
          Format as JSON: {{"analysis": "...", "fixes": [{{"file": "path", "content": "..."}}]}}"""}
              ],
              temperature=0.2
          )
          
          result = json.loads(response.choices[0].message.content)
          
          # Apply fixes
          for fix in result["fixes"]:
              with open(fix["file"], "w") as f:
                  f.write(fix["content"])
              print(f"Fixed {fix['file']}")
          
          # Output for PR
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"analysis<<EOF\n{result['analysis']}\nEOF\n")
          EOFPYTHON
          
          python autofix.py

      - name: Verify Tests
        id: test-verify
        run: npm test || echo "Tests still failing - needs manual review"

      - name: Create PR
        if: steps.test-verify.outcome == 'success'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(ci): auto-fix via Codex"
          branch: codex-auto-fix-${{ github.event.workflow_run.run_id || github.run_id }}
          title: "ðŸ¤– Auto-fix: ${{ github.event.workflow_run.name || 'CI Failure' }}"
          body: |
            ## Automated Fix Applied
            
            **Triggered by:** Failed workflow run #${{ github.event.workflow_run.run_number || github.run_number }}
            
            **Analysis:**
            ${{ steps.codex.outputs.analysis }}
            
            ---
            
            âš ï¸ **Review Required:** Please verify this fix before merging.
            
            **Original run:** ${{ github.event.workflow_run.html_url || github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Triggering branch:** ${{ github.event.workflow_run.head_branch || github.ref_name }}
          delete-branch: true