name: Universal CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  auto-detect-and-test:
    runs-on: ubuntu-latest
        permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      # üêç PYTHON PATH (If requirements.txt exists)
      - name: Setup Python
        if: hashFiles('requirements.txt') != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python Dependencies
        if: hashFiles('requirements.txt') != ''
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest flake8

      - name: Run Python Tests
        if: hashFiles('requirements.txt') != ''
        run: |
          # Run tests if they exist, otherwise pass
          if [ -d "tests" ] || [ -f "test_*.py" ]; then
            pytest
          else
            echo "No Python tests found, skipping"
          fi

      # üì¶ NODE.JS PATH (Only if package.json exists in root)
      - name: Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Only cache if lockfile exists to prevent errors
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      - name: Install Node Dependencies
        if: hashFiles('package.json') != ''
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Run Node Tests
        if: hashFiles('package.json') != ''
        run: npm test --if-present

      # üê≥ DOCKER PATH (Always build if Dockerfile exists)
      - name: Build Docker Image
        if: hashFiles('Dockerfile') != ''
        run: |
          docker build -t app:${{ github.sha }} .
          echo "‚úÖ Docker build successful"

      - name: Final Status
        run: echo "‚úÖ Pipeline completed successfully"
