name: Automated PR & Issue Management

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  # ü§ñ Auto-label PRs
  auto-label-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Label by file changes
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Label by size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size: xs'
          xs_max_size: 10
          s_label: 'size: s'
          s_max_size: 100
          m_label: 'size: m'
          m_max_size: 500
          l_label: 'size: l'
          l_max_size: 1000
          xl_label: 'size: xl'

  # üìù Auto-comment on new PRs
  welcome-pr:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Comment on new PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üëã Welcome to NWU Protocol!
              
              Thank you for your contribution! Here's what happens next:
              
              1. ‚úÖ Automated tests will run
              2. üîç Code quality checks will be performed
              3. üëÄ A maintainer will review your changes
              
              ### üìÑ Checklist
              - [ ] Tests pass
              - [ ] Code follows style guidelines
              - [ ] Documentation is updated
              - [ ] Commits are atomic and well-described
              
              **Need help?** Check out our [Contributing Guide](../blob/main/CONTRIBUTING.md)`
            })

  # üéØ Auto-assign reviewers
  assign-reviewers:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Assign reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const reviewers = ['Garrettc123']  // Add team members
            if (context.payload.pull_request.user.login !== reviewers[0]) {
              github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                reviewers: reviewers
              })
            }

  # ü§ñ Auto-merge dependabot PRs
  auto-merge-dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Auto-approve minor/patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Enable auto-merge
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # üí¨ Auto-respond to issue commands
  issue-commands:
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.action == 'created'
    permissions:
      issues: write
    steps:
      - name: Process commands
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase()
            const issue_number = context.issue.number
            
            // /help command
            if (comment.includes('/help')) {
              github.rest.issues.createComment({
                issue_number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üí° Available Commands\n\n- \`/help\` - Show this help message\n- \`/assign-me\` - Assign this issue to yourself\n- \`/estimate <hours>\` - Add time estimate\n- \`/priority <high|medium|low>\` - Set priority\n- \`/close\` - Close this issue`
              })
            }
            
            // /assign-me command
            if (comment.includes('/assign-me')) {
              github.rest.issues.addAssignees({
                issue_number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                assignees: [context.payload.comment.user.login]
              })
              github.rest.issues.createComment({
                issue_number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚úÖ Assigned to @${context.payload.comment.user.login}!`
              })
            }
            
            // /priority command
            if (comment.includes('/priority')) {
              const priority = comment.match(/\/priority\s+(high|medium|low)/)?.[1]
              if (priority) {
                github.rest.issues.addLabels({
                  issue_number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: [`priority: ${priority}`]
                })
              }
            }

  # üéØ Auto-close stale issues
  stale-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: 'This issue has been inactive for 30 days. If still relevant, please comment to keep it open.'
          close-issue-message: 'Closing due to inactivity. Feel free to reopen if needed!'
          stale-pr-message: 'This PR has been inactive for 14 days. Please update or it will be closed.'
          close-pr-message: 'Closing due to inactivity. Feel free to reopen when ready!'
          days-before-stale: 30
          days-before-close: 7
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          exempt-issue-labels: 'pinned,security'
          exempt-pr-labels: 'wip,on-hold'
