name: ðŸ”„ Auto PR Creation

on:
  push:
    branches:
      - main
      - develop
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      pr_type:
        description: 'Type of PR to create'
        required: true
        default: 'dependency-update'
        type: choice
        options:
          - dependency-update
          - weekly-maintenance
          - security-patch

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Check for dependency updates
  dependency-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.pr_type == 'dependency-update' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check for outdated packages
        id: check-updates
        run: |
          if [ -f "package.json" ]; then
            echo "Checking for npm updates..."
            npm outdated --json > outdated.json || true
            
            if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "Updates available"
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
              echo "No updates available"
            fi
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No package.json found"
          fi
      
      - name: Create dependency update PR
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const branchName = `chore/auto-dependency-update-${Date.now()}`;
            
            // Create branch
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${context.ref.replace('refs/heads/', '')}`
            });
            
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: ref.object.sha
            });
            
            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'chore: automated dependency updates',
              head: branchName,
              base: context.ref.replace('refs/heads/', ''),
              body: `## ðŸ¤– Automated Dependency Updates\n\n` +
                    `This PR contains automated dependency updates.\n\n` +
                    `### What's Changed\n` +
                    `- Updated outdated npm packages\n\n` +
                    `### Testing\n` +
                    `- [ ] All CI checks pass\n` +
                    `- [ ] No breaking changes detected\n\n` +
                    `**Auto-generated by GitHub Actions**`
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['dependencies', 'auto-merge', 'automated']
            });
            
            core.info(`âœ… Created PR #${pr.number}`);

  # Weekly maintenance PR
  weekly-maintenance:
    name: Create Weekly Maintenance PR
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.pr_type == 'weekly-maintenance')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for maintenance needs
        id: check-maintenance
        run: |
          echo "Checking for maintenance tasks..."
          
          # Check for TODO comments
          TODO_COUNT=$(git grep -i "TODO\|FIXME\|XXX" | wc -l || echo 0)
          
          # Check for outdated comments (older than 6 months)
          # This is a placeholder - actual implementation would be more complex
          
          echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "has_maintenance=true" >> $GITHUB_OUTPUT
          else
            echo "has_maintenance=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create maintenance report
        if: steps.check-maintenance.outputs.has_maintenance == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const todoCount = '${{ steps.check-maintenance.outputs.todo_count }}';
            
            const report = `## ðŸ“‹ Weekly Maintenance Report\n\n` +
              `This is an automated weekly maintenance check.\n\n` +
              `### Findings\n` +
              `- **TODO/FIXME Comments**: ${todoCount} found\n\n` +
              `### Recommended Actions\n` +
              `- Review and address TODO/FIXME comments\n` +
              `- Update outdated documentation\n` +
              `- Check for deprecated dependencies\n` +
              `- Review and close stale issues\n\n` +
              `**Generated**: ${new Date().toISOString()}\n`;
            
            // Create issue instead of PR for maintenance report
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“‹ Weekly Maintenance Report - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['maintenance', 'automated']
            });
            
            core.info(`âœ… Created maintenance issue #${issue.number}`);

  # Check for security vulnerabilities
  security-check:
    name: Security Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Run security audit
        id: audit
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            npm audit --json > audit.json || true
            
            # Check if there are vulnerabilities
            VULN_COUNT=$(cat audit.json | grep -o '"vulnerabilities"' | wc -l)
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
              echo "Vulnerabilities found"
            else
              echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
              echo "No vulnerabilities"
            fi
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create security issue
        if: steps.audit.outputs.has_vulnerabilities == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const issueTitle = `ðŸ”’ Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`;
            
            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes('Security Vulnerabilities Detected')
            );
            
            if (existingIssue) {
              core.info(`Security issue already exists: #${existingIssue.number}`);
              return;
            }
            
            const issueBody = `## ðŸ”’ Security Vulnerabilities Detected\n\n` +
              `Automated security scan has detected vulnerabilities in dependencies.\n\n` +
              `### Action Required\n` +
              `1. Run \`npm audit\` locally to see details\n` +
              `2. Run \`npm audit fix\` to automatically fix issues\n` +
              `3. For breaking changes, manually update dependencies\n` +
              `4. Verify all tests pass after updates\n\n` +
              `**Detected**: ${new Date().toISOString()}\n`;
            
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['security', 'high-priority', 'automated']
            });
            
            core.info(`âœ… Created security issue #${issue.number}`);
